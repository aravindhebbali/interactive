---
title: "R & SQLite"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
knitr::opts_chunk$set(echo = FALSE)
ecom <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
con <- DBI::dbConnect(RSQLite::SQLite(), ":memory:")
copy_to(con, ecom)
query <- DBI::dbSendQuery(con, 'select * from ecom')
result <- DBI::dbFetch(query, n = 30)
```

## Connection

### Connection Summary

<hr>

```{r lite3, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Connection Summary'}
summary(con)
```

### List Tables

<hr>

```{r lite6, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'List Tables'}
dbListTables(con)
```

### List Fields

<hr>

```{r lite7, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'List Fields'}
DBI::dbListFields(con, "ecom")
```

## Querying Data

<hr>

- `dbReadTable()`: read entire table
- `dbGetQuery()`: read few rows
- `dbSendQuery()` & `dbFetch()`: read data in batches

### Entire Table

<hr>

```{r lite8, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Entire Table'}
DBI::dbReadTable(con, 'ecom')
```

### Few Rows

<hr>

```{r lite9, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Rows'}
DBI::dbGetQuery(con, "select * from ecom limit 10")
```

### Read Data in Batches

<hr>

```{r lite10, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Read Data in Batches'}
query <- DBI::dbSendQuery(con, 'select * from ecom')
result <- DBI::dbFetch(query, n = 30)
result
```

## Query

### Query Status

<hr>

```{r lite11, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Status'}
DBI::dbHasCompleted(query)
```

### Query Info

<hr>

```{r lite12, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Info'}
DBI::dbGetInfo(query)
```

### Latest Query

<hr>

```{r lite13, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Latest Query'}
DBI::dbGetStatement(query)
```

### Rows Fetched

<hr>

```{r lite14, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Rows Fetched'}
DBI::dbGetRowCount(query)
```

### Rows Affected

<hr>

```{r lite15, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Rows Affected'}
DBI::dbGetRowsAffected(query)
```

### Column Info

<hr>

```{r lite16, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Column Information'}
DBI::dbColumnInfo(query)
```

### Clear Results

<hr>

```{r lite17, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Clear Results'}
DBI::dbClearResult(query)
```

## Create Table

### Introduction

<hr>

```{r lite18, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Write Table'} 
x <- 1:10
y <- letters[1:10]
trial <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial)
```

### check if table is created in database

<hr>

```{r lite19, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Check if Table Exists'}
DBI::dbListTables(con)
DBI::dbExistsTable(con, "trial")
```

### query sample data from table

<hr>

```{r lite20, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Sample Data'}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

### overwrite table in the database

<hr>

```{r lite21, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Overwrite Table'}
x <- sample(100, 10)
y <- letters[11:20]
trial2 <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial2, overwrite = TRUE)
```

### query sample data from table to see if it has been overwritten

<hr>

```{r lite22, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Sample Data'}
DBI::dbGetQuery(con, "select * from trial limit 5")
```

### append data to the table in the database

<hr>

```{r lite23, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Append Data'}
x <- sample(100, 10)
y <- letters[5:14]
trial3 <- tibble::tibble(x, y)
DBI::dbWriteTable(con, "trial", trial3, append = TRUE)
```

### query sample data from table to see if new data is appended

<hr>

```{r lite24, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Query Sample Data'}
DBI::dbReadTable(con, "trial")
```

## Insert Rows

### Introduction

<hr>

```{r lite25, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Insert Rows'}
DBI::dbExecute(con,
  "INSERT into trial (x, y) VALUES (32, 'c'), (45, 'k'), (61, 'h')"
)
```

### Insert Rows

<hr>

```{r lite26, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Insert Rows'}
DBI::dbSendStatement(con,
  "INSERT into trial (x, y) VALUES (25, 'm'), (54, 'l'), (16, 'y')"
)
```


## SQLite Data Type

<hr>

```{r lite27, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Data Types'}
DBI::dbDataType(RSQLite::SQLite(), "a")
DBI::dbDataType(RSQLite::SQLite(), 1:5)
DBI::dbDataType(RSQLite::SQLite(), 1.5)
```

## Others

### remove table from database

<hr>

```{r lite28, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Remove Table'}
DBI::dbRemoveTable(con, "trial")
```

### check if table has been removed 

<hr> 

```{r lite29, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'List Tables'}
DBI::dbListTables(con)
```

### Generate SQL Query

<hr>

```{r lite31, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Generate Query'}
DBI::sqlCreateTable(con, "new", c(x = "integer", y = "text"))
```

## Append Table

<hr>

```{r lite32, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Append Table'}
DBI::sqlAppendTable(con, "ecom", head(ecom))
```

## Close Connection

<hr>

```{r lite30, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Disconnect'}
DBI::dbDisconnect(con)
```
