---
title: "How to work with dates in R?"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(lubridate)
library(dplyr)
library(magrittr)
knitr::opts_chunk$set(echo = FALSE)
transact <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/transact.csv')
```

## Introduction

<hr>

 In this module, we will learn to work with date/time data in R using [lubridate]( https://CRAN.R-project.org/package=lubridate), an R package that makes it easy to work with dates and time. Let us begin by installing and loading the lubridate pacakge.

## Quick Tour

### Origin

<hr>

```{r origin, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Orign'}
lubridate::origin
```

### Current Date/Time

<hr>

```{r today, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Current Date & Time'}
now()
today()
am(now())  
pm(now())
```

## Data

### Data

<hr>

```{r show, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Data Overview'}
transact
```

### Data Dictionary

<hr>

The data set has 3 columns. All the dates are in the format (yyyy-mm-dd).

- Invoice: invoice date 
- Due: due date
- Payment: payment date

### Case Study

<hr>

We will use the functions in the lubridate package to answer a few 
questions we have about the transact data.

- extract date, month and year from Due
- compute the number of days to settle invoice
- compute days over due
- check if due year is a leap year
- check when due day in february is 29, whether it is a leap year
- how many invoices were settled within due date
- how many invoices are due in each quarter
- what is the average duration between invoice date and payment date


## Case Study 1

### Extract Date, Month & Year from Due Date

<hr>

```{r lub2, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Extract - Part 1'}
transact %>%
  mutate(
    due_day = day(Due),
    due_month = month(Due),
    due_year = year(Due)
  )
```

### compute days to settle invoice

<hr>

```{r lub3, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Compute - Part 1'}
transact %>%
  mutate(
    days_to_pay = Payment - Invoice
  )
```

### compute days over due

<hr>

```{r lub4, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Compute - Part 2'}
transact %>%
  mutate(
    delay = Payment - Due
  )
```

## Case Study 2

### Is due year a leap year?

<hr>

```{r lub5, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Leap year - Part 1'}
transact %>%
  mutate(
    due_year = year(Due),
    is_leap = leap_year(due_year)
  )
```

### If due day is February 29, is it a leap year?

<hr>

```{r lub6, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Leap Year - Part 2'}
transact %>%
  mutate(
    due_day = day(Due),
    due_month = month(Due),
    days_due_month = days_in_month(due_month),
    due_year = year(Due),
    is_leap = leap_year(due_year)
  ) %>%
  select(-(Invoice), -(Payment)) %>%
  filter(due_month == 2)
```

## Case Study 3

### how many invoices were settled within due date?

<hr>

```{r lub7, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Settlement Date - Part 1'}
transact %>%
  mutate(
    inv_due_interval = interval(Invoice, Due),
    due_next = Due + days(1),
    due_pay_interval = interval(due_next, Payment),
    overlaps = int_overlaps(inv_due_interval, due_pay_interval)
  ) %>%
  select(inv_due_interval, due_next, due_pay_interval, overlaps)
```

### how many invoices were settled within due date?

<hr>

````{r lub12, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Settlement Date - Part 2'}
# using int_shift
transact %>%
  mutate(
    inv_due_interval = interval(Invoice, Due),
    due_pay_interval = interval(Due, Payment),  
    due_pay_next = int_shift(due_pay_interval, by = days(1)),
    overlaps = int_overlaps(inv_due_interval, due_pay_next)
  ) %>%
  select(inv_due_interval, due_pay_next, overlaps)
```

### how many invoices were settled within due date?

<hr>

```{r lub13, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Settlement Date - Part 3'}
transact %>%
  mutate(
    inv_due_interval = interval(Invoice, Due),
    overlaps = Payment %within% inv_due_interval
  ) %>%
  select(Due, Payment, overlaps)
```

## Case Study 4

### Quarter

<hr>

```{r lub8, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Quarter'}
transact %>%
  mutate(
    Quarter = quarter(Due)
  )
```

```{r lub14, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Quarter'}
transact %>%
  mutate(
    Quarter = quarter(Due, with_year = TRUE)
  )
```

## Case Study 5

### Data

<hr>

```{r lub9, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Data'}
transact %<>%
  mutate(
    days_to_pay = Payment - Invoice
  )
```

### Duration

<hr>

```{r lub15, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Duration'}
transact %>%
  mutate(
    dseconds = duration(as.numeric(days_to_pay), 'days')
  )
```

### Interval

<hr>

```{r lub10, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Interval'}
transact %<>%
  mutate(
    inv_pay_int = interval(Invoice, Payment)
  )
```

### Days

<hr>

```{r lub11, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Days'}
transact %>%
  mutate(
    inv_pay_days = inv_pay_int / ddays()
  )
```

### Time Length

<hr>

```{r lub16, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Time Length'}
transact %>%
  mutate(
    inv_pay_days = time_length(inv_pay_int, unit = "days")
  )
```

### Period

<hr>

```{r lub17, exercise = TRUE, exercise.eval = FALSE, exercise.cap = 'Period'}
transact %>%
  mutate(
    inv_pay_days = as.period(inv_pay_int)
  )
```
